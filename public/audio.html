<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base64éŸ³é¢‘æ’­æ”¾å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 40px;
            font-size: 32px;
        }

        .audio-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }

        .audio-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .audio-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .audio-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .audio-title::before {
            content: 'ğŸµ';
            font-size: 24px;
        }

        .audio-player {
            width: 100%;
            margin-bottom: 15px;
            border-radius: 10px;
        }

        .audio-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .status.loaded {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .file-size {
            color: #666;
            font-size: 14px;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ Base64éŸ³é¢‘æ’­æ”¾å™¨</h1>
        
        <div class="audio-list" id="audioList">
            <!-- éŸ³é¢‘å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        const audioFiles = [
            { filename: 'video1.json', name: 'éŸ³é¢‘ç‰‡æ®µ 1' },
            { filename: 'video2.json', name: 'éŸ³é¢‘ç‰‡æ®µ 2' },
            { filename: 'video3.json', name: 'éŸ³é¢‘ç‰‡æ®µ 3' }
        ];

        async function loadAudio(audioFile) {
            const cardId = `audio-${audioFile.filename}`;
            const cardEl = document.getElementById(cardId);
            if (!cardEl) {
                console.error(`æ‰¾ä¸åˆ°å¡ç‰‡å…ƒç´ : ${cardId}`);
                return;
            }

            const statusEl = cardEl.querySelector('.status');
            const audioEl = cardEl.querySelector('audio');
            const errorEl = cardEl.querySelector('.error-message');

            if (!statusEl || !audioEl || !errorEl) {
                console.error(`æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ : ${cardId}`);
                return;
            }

            statusEl.textContent = 'åŠ è½½ä¸­...';
            statusEl.className = 'status loading';
            statusEl.innerHTML = '<span class="loading-spinner"></span>åŠ è½½ä¸­...';
            errorEl.textContent = '';

            try {
                const response = await fetch(`/api/audio/${audioFile.filename}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }

                // æ£€æŸ¥è¿”å›çš„æ•°æ®ç»“æ„
                if (!data.audioBase64) {
                    throw new Error('æœåŠ¡å™¨è¿”å›çš„æ•°æ®ä¸­æ²¡æœ‰ audioBase64 å­—æ®µ');
                }

                // æå–base64æ•°æ®ï¼ˆç¡®ä¿æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼‰
                let audioBase64 = String(data.audioBase64).trim();
                
                // å¦‚æœæ•°æ®å‰é¢æœ‰ "audioBase64" å­—ç¬¦ä¸²ï¼Œç§»é™¤å®ƒ
                if (audioBase64.startsWith('audioBase64')) {
                    console.warn('æ£€æµ‹åˆ°æ•°æ®å‰ç¼€ï¼Œæ­£åœ¨æ¸…ç†...');
                    audioBase64 = audioBase64.replace(/^audioBase64\s*/, '');
                }
                
                // æ¸…ç†Base64æ•°æ®ï¼šç§»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦ï¼ˆç©ºæ ¼ã€æ¢è¡Œç­‰ï¼‰
                let base64Data = '';
                let mimeType = 'audio/wav'; // é»˜è®¤ä½¿ç”¨WAVæ ¼å¼
                
                if (audioBase64.startsWith('data:')) {
                    // å¦‚æœå·²ç»æœ‰data URIå‰ç¼€
                    const parts = audioBase64.split(',');
                    mimeType = parts[0].replace('data:', '');
                    base64Data = parts.slice(1).join(',').replace(/\s+/g, '');
                } else {
                    // å¦‚æœæ²¡æœ‰data URIå‰ç¼€ï¼Œæ£€æµ‹æ ¼å¼
                    base64Data = audioBase64.replace(/\s+/g, '');
                    
                    // æ£€æµ‹éŸ³é¢‘æ ¼å¼ï¼šWAVæ–‡ä»¶é€šå¸¸ä»¥"UklGR"å¼€å¤´ï¼ˆRIFFçš„Base64ç¼–ç ï¼‰
                    if (base64Data.startsWith('UklGR')) {
                        mimeType = 'audio/wav';
                    } else if (base64Data.startsWith('/9j/') || base64Data.startsWith('iVBOR')) {
                        // è¿™äº›æ˜¯å›¾ç‰‡æ ¼å¼ï¼Œä¸åº”è¯¥å‡ºç°
                        throw new Error('æ£€æµ‹åˆ°ééŸ³é¢‘æ ¼å¼æ•°æ®');
                    } else {
                        // é»˜è®¤å°è¯•WAVï¼Œå¦‚æœä¸è¡Œå¯ä»¥å°è¯•å…¶ä»–æ ¼å¼
                        mimeType = 'audio/wav';
                    }
                }
                
                // éªŒè¯Base64æ•°æ®é•¿åº¦
                if (base64Data.length === 0) {
                    throw new Error('Base64æ•°æ®ä¸ºç©º');
                }
                
                // éªŒè¯Base64æ ¼å¼ï¼ˆåªåŒ…å«Base64å­—ç¬¦ï¼‰
                const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
                if (!base64Regex.test(base64Data)) {
                    console.warn('Base64æ•°æ®å¯èƒ½åŒ…å«æ— æ•ˆå­—ç¬¦ï¼Œå°è¯•æ¸…ç†...');
                    base64Data = base64Data.replace(/[^A-Za-z0-9+/=]/g, '');
                }
                
                console.log(`å¤„ç†åçš„éŸ³é¢‘æ•°æ®é•¿åº¦: ${base64Data.length} å­—ç¬¦`);
                console.log(`ä½¿ç”¨çš„MIMEç±»å‹: ${mimeType}`);
                console.log(`Base64å‰50å­—ç¬¦: ${base64Data.substring(0, 50)}`);

                // æ·»åŠ éŸ³é¢‘å…ƒç´ çš„äº‹ä»¶ç›‘å¬
                audioEl.onerror = (e) => {
                    console.error('éŸ³é¢‘åŠ è½½é”™è¯¯:', e);
                    console.error('éŸ³é¢‘å…ƒç´ é”™è¯¯è¯¦æƒ…:', audioEl.error);
                    console.error('é”™è¯¯ä»£ç :', audioEl.error?.code);
                    console.error('é”™è¯¯æ¶ˆæ¯:', audioEl.error?.message);
                    statusEl.textContent = 'æ’­æ”¾å¤±è´¥';
                    statusEl.className = 'status error';
                    errorEl.textContent = `éŸ³é¢‘æ ¼å¼é”™è¯¯æˆ–æ•°æ®æŸå (é”™è¯¯ä»£ç : ${audioEl.error?.code || 'æœªçŸ¥'})`;
                };

                audioEl.onloadeddata = () => {
                    console.log(`éŸ³é¢‘ ${audioFile.filename} åŠ è½½æˆåŠŸ`);
                    statusEl.textContent = 'å·²åŠ è½½';
                    statusEl.className = 'status loaded';
                };

                audioEl.oncanplay = () => {
                    console.log(`éŸ³é¢‘ ${audioFile.filename} å¯ä»¥æ’­æ”¾`);
                };

                // å°è¯•ä½¿ç”¨ Blob URL è€Œä¸æ˜¯ data URIï¼ˆæŸäº›æµè§ˆå™¨å¯¹ data URI æœ‰é™åˆ¶ï¼‰
                try {
                    // å°† Base64 è½¬æ¢ä¸ºäºŒè¿›åˆ¶
                    const binaryString = atob(base64Data);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    // åˆ›å»º Blob
                    const blob = new Blob([bytes], { type: mimeType });
                    const blobUrl = URL.createObjectURL(blob);
                    
                    console.log(`ä½¿ç”¨ Blob URL åŠ è½½éŸ³é¢‘`);
                    
                    // è®¾ç½®éŸ³é¢‘æºä¸º Blob URL
                    audioEl.src = blobUrl;
                    
                    // æ¸…ç†ï¼šå½“éŸ³é¢‘å…ƒç´ è¢«ç§»é™¤æ—¶é‡Šæ”¾ Blob URL
                    audioEl.addEventListener('loadstart', () => {
                        // å¦‚æœä¹‹å‰æœ‰ Blob URLï¼Œå…ˆé‡Šæ”¾
                        if (audioEl.dataset.blobUrl) {
                            URL.revokeObjectURL(audioEl.dataset.blobUrl);
                        }
                        audioEl.dataset.blobUrl = blobUrl;
                    });
                } catch (blobError) {
                    console.warn('Blob URL åˆ›å»ºå¤±è´¥ï¼Œå›é€€åˆ° data URI:', blobError);
                    // å›é€€åˆ° data URI
                    const dataUri = `data:${mimeType};base64,${base64Data}`;
                    audioEl.src = dataUri;
                }
                
                // ç­‰å¾…éŸ³é¢‘å…ƒæ•°æ®åŠ è½½
                audioEl.load();
                
                // è®¡ç®—æ–‡ä»¶å¤§å°ï¼ˆè¿‘ä¼¼å€¼ï¼‰
                const base64Length = data.audioBase64.length;
                const fileSizeKB = Math.round((base64Length * 3) / 4 / 1024);
                const fileSizeEl = cardEl.querySelector('.file-size');
                if (fileSizeEl) {
                    fileSizeEl.textContent = `çº¦ ${fileSizeKB} KB`;
                }

            } catch (error) {
                console.error('åŠ è½½éŸ³é¢‘å¤±è´¥:', error);
                statusEl.textContent = 'åŠ è½½å¤±è´¥';
                statusEl.className = 'status error';
                errorEl.textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        function createAudioCard(audioFile) {
            const card = document.createElement('div');
            card.className = 'audio-card';
            card.id = `audio-${audioFile.filename}`;
            
            card.innerHTML = `
                <div class="audio-title">${audioFile.name}</div>
                <audio class="audio-player" controls preload="none">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                </audio>
                <div class="audio-info">
                    <div>
                        <span class="status loading">å‡†å¤‡åŠ è½½</span>
                        <span class="file-size"></span>
                    </div>
                </div>
                <div class="error-message"></div>
            `;
            
            // è·å–éŸ³é¢‘å…ƒç´ å¹¶æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
            const audioEl = card.querySelector('audio');
            if (audioEl) {
                // æ·»åŠ æ’­æ”¾ç›¸å…³çš„è°ƒè¯•ä¿¡æ¯
                audioEl.addEventListener('play', () => {
                    console.log(`å¼€å§‹æ’­æ”¾: ${audioFile.filename}`);
                });
                
                audioEl.addEventListener('pause', () => {
                    console.log(`æš‚åœæ’­æ”¾: ${audioFile.filename}`);
                });
                
                audioEl.addEventListener('ended', () => {
                    console.log(`æ’­æ”¾ç»“æŸ: ${audioFile.filename}`);
                });
            }
            
            return card;
        }

        // åˆå§‹åŒ–é¡µé¢
        function init() {
            const audioList = document.getElementById('audioList');
            
            if (!audioList) {
                console.error('æ‰¾ä¸åˆ°audioListå…ƒç´ ');
                return;
            }
            
            audioFiles.forEach((audioFile, index) => {
                const card = createAudioCard(audioFile);
                audioList.appendChild(card);
                
                // å»¶è¿ŸåŠ è½½ï¼Œé¿å…åŒæ—¶åŠ è½½å¤šä¸ªå¤§æ–‡ä»¶
                // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿DOMå·²å®Œå…¨æ¸²æŸ“
                setTimeout(() => {
                    requestAnimationFrame(() => {
                        loadAudio(audioFile);
                    });
                }, index * 500);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

