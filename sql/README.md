# 数据库初始化说明

## 📁 文件说明

此文件夹包含所有数据库表的SQL定义文件：

- `bookmarks.sql` - 网址导航表
- `chat_messages.sql` - 聊天室消息表
- `diaries.sql` - 日记表
- `weight_records.sql` - 减肥记录表
- `init_database.js` - 智能数据库初始化脚本

## 🚀 使用方法

### 方法一：使用npm脚本（推荐）

```bash
npm run init-db
```

### 方法二：直接运行脚本

```bash
node sql/init_database.js
```

## ⚙️ 配置

脚本会自动从以下位置读取数据库配置（按优先级）：

1. **环境变量**（推荐用于生产环境）：
   ```bash
   DB_HOST=localhost
   DB_PORT=3306
   DB_USER=root
   DB_PASSWORD=your_password
   DB_NAME=your_database
   ```

2. **默认配置**（开发环境）：
   - 主机: localhost
   - 端口: 3306
   - 用户: root
   - 密码: 199808
   - 数据库: xl

## 🔍 功能特性

### 智能检测
- ✅ 自动检测表是否存在
- ✅ 自动检测字段是否完整
- ✅ 自动检测索引是否完整
- ✅ 自动创建缺失的表
- ✅ 自动添加缺失的字段
- ✅ 自动添加缺失的索引

### 安全特性
- ✅ 使用 `CREATE TABLE IF NOT EXISTS` 避免重复创建
- ✅ 只添加缺失的字段，不会删除现有字段
- ✅ 只添加缺失的索引，不会删除现有索引
- ✅ 保留现有数据

## 📊 执行流程

1. 连接数据库
2. 遍历所有SQL文件
3. 对每个表：
   - 如果表不存在 → 创建表
   - 如果表存在 → 检查字段和索引
     - 添加缺失的字段
     - 添加缺失的索引
4. 输出执行总结

## 📝 示例输出

```
🚀 开始初始化数据库...

📊 数据库配置:
   主机: localhost:3306
   数据库: xl
   用户: root

✅ 数据库连接成功

📄 处理文件: bookmarks.sql
  📋 表名: bookmarks
  ✓ 表已存在，检查字段和索引...
  ✅ 表结构完整，无需更新

📄 处理文件: weight_records.sql
  📋 表名: weight_records
  🔨 表不存在，正在创建...
  ✅ 表创建成功: weight_records

==================================================
📊 执行总结:
==================================================

✅ 新建表 (1):
   - weight_records

✓ 检查通过 (3):
   - bookmarks
   - chat_messages
   - diaries

==================================================
✨ 数据库初始化完成！
```

## ⚠️ 注意事项

1. **外键依赖**：确保 `user` 表已存在，因为其他表都依赖它
2. **数据安全**：脚本不会删除任何现有数据或字段
3. **权限要求**：需要 CREATE、ALTER、INDEX 权限
4. **备份建议**：在生产环境执行前，建议先备份数据库

## 🔄 迁移到新数据库

当你需要迁移到新的数据库时：

1. 创建新的数据库
2. 确保 `user` 表已存在（或先创建用户表）
3. 运行初始化脚本：
   ```bash
   npm run init-db
   ```
4. 脚本会自动创建所有需要的表和字段

## 📞 问题排查

如果遇到问题：

1. 检查数据库连接配置是否正确
2. 检查数据库用户是否有足够权限
3. 检查 `user` 表是否存在（其他表依赖它）
4. 查看控制台输出的错误信息



